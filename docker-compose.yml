services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    volumes:
      - ./data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - MIMO_CLAUDE_API_KEY=${MIMO_CLAUDE_API_KEY:-}
      - MIMO_DEBUG=${MIMO_DEBUG:-false}
    depends_on:
      sandbox-build:
        condition: service_completed_successfully

  sandbox-build:
    image: docker:cli
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./Dockerfile.sandbox:/Dockerfile.sandbox:ro
    command: docker build -t mimo-sandbox:latest -f /Dockerfile.sandbox /
    restart: "no"
